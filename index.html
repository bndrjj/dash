<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة متابعة دعم التميز المدرسي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f3d3e;
            --secondary: #1f6f78;
            --accent: #2b8a9b;
            --accent-light: #e2f1f3;
            --bg: #f5f7f9;
            --card: #ffffff;
            --text: #0b2c2f;
            --muted: #5c6f73;
            --border: #d7e3e5;
            --shadow: rgba(15, 61, 62, 0.08);
            --icon: #0f3d3e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', 'Cairo', sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        h1,
        h2,
        h3,
        h4,
        .section-title {
            font-family: 'Cairo', sans-serif;
            letter-spacing: 0.2px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 20px 50px;
        }

        .top-bar {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 16px;
            padding: 20px 28px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            box-shadow: 0 18px 40px var(--shadow);
        }

        .top-bar .title-group h1 {
            font-size: 1.8rem;
            margin-bottom: 0;
            font-weight: 700;
        }

        .top-bar .title-row {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 8px;
        }

        .top-bar .report-logo {
            height: 48px;
            width: auto;
            object-fit: contain;
            flex-shrink: 0;
        }

        .top-bar .title-group p {
            font-size: 1rem;
            opacity: 0.85;
        }

        .top-bar .meta {
            text-align: left;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 18px;
            border-radius: 12px;
            font-size: 0.95rem;
        }

        .filters {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }

        .classification-row {
            margin-top: 22px;
            display: grid;
            grid-template-columns: repeat(4, minmax(160px, 1fr));
            gap: 12px;
        }

        .classification-item {
            background: var(--card);
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 24px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .classification-item span {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .classification-item strong {
            font-size: 1.2rem;
            color: var(--primary);
        }

        .filter-card {
            background: var(--card);
            border-radius: 14px;
            padding: 16px 18px;
            box-shadow: 0 12px 30px var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-card label {
            font-size: 0.85rem;
            color: var(--muted);
            display: block;
            margin-bottom: 8px;
        }

        .filter-card select,
        .filter-card input {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.95rem;
            font-family: inherit;
            background: #fff;
        }

        .stats-grid {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px 22px;
            border: 1px solid var(--border);
            box-shadow: 0 12px 30px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
        }

        .stat-card h3 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .stat-card p {
            color: var(--muted);
            font-size: 0.95rem;
        }

        .stat-subtext {
            color: var(--muted);
            font-size: 0.8rem;
            margin-top: 6px;
        }

        .section {
            margin-top: 32px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }

        .title-with-icon {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .title-icon {
            width: 18px;
            height: 18px;
            stroke: var(--icon);
            fill: none;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            flex-shrink: 0;
        }

        .section-subtitle {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 12px 30px var(--shadow);
        }

        .card h4 {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .metric-list {
            display: grid;
            gap: 10px;
        }

        .metric-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 10px;
            background: var(--accent-light);
            font-size: 0.95rem;
        }

        .metric-row span {
            font-weight: 600;
            color: var(--primary);
        }

        .bar-list {
            display: grid;
            gap: 12px;
        }

        .bar-row {
            display: grid;
            grid-template-columns: 110px 1fr 60px;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
        }

        .bar-track {
            background: #edf3f4;
            border-radius: 999px;
            height: 10px;
            overflow: hidden;
        }

        .bar-track span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            border-radius: inherit;
        }

        .compliance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 16px;
        }

        .compliance-card {
            background: var(--card);
            border-radius: 16px;
            padding: 18px;
            border: 1px solid var(--border);
            box-shadow: 0 12px 30px var(--shadow);
        }

        .compliance-card h4 {
            font-size: calc(1rem - 5px);
            margin-bottom: 12px;
            color: var(--primary);
        }

        .compliance-values {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge.yes { background: #dff3e4; color: #1f6f3f; }
        .badge.no { background: #fde2e2; color: #a33a3a; }
        .badge.unknown { background: #f3f0d7; color: #7d6f1b; }

        .progress {
            margin-top: 12px;
            height: 8px;
            background: #edf3f4;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
        }

        .compliance-gauge {
            margin-top: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .gauge-ring {
            --value: 0;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--secondary) calc(var(--value) * 1%), #e8eff1 0);
            display: grid;
            place-items: center;
            position: relative;
        }

        .gauge-ring::after {
            content: '';
            position: absolute;
            width: 86px;
            height: 86px;
            border-radius: 50%;
            background: #fff;
            box-shadow: inset 0 0 0 1px rgba(15, 61, 62, 0.08);
        }

        .gauge-ring span {
            position: relative;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            z-index: 1;
        }

        .gauge-caption {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .supervisory-grid {
            margin-top: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .supervisory-domain h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            margin-bottom: 14px;
            color: var(--primary);
        }

        .footer {
            margin-top: 40px;
            text-align: center;
            color: var(--muted);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .classification-row {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }

            .bar-row {
                grid-template-columns: 1fr;
                align-items: start;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="top-bar">
            <div class="title-group">
                <h1>لوحة متابعة دعم التميز المدرسي</h1>
                <p>جاري تحميل البيانات...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        const normalizeDigits = (value) => String(value)
            .replace(/[٠-٩]/g, (digit) => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(digit)])
            .replace(/[۰-۹]/g, (digit) => '0123456789'['۰۱۲۳۴۵۶۷۸۹'.indexOf(digit)]);

        const numberFormatter = new Intl.NumberFormat('en-US');

        const formatNumber = (value) => {
            const normalized = normalizeDigits(value);
            const numeric = typeof value === 'number' ? value : Number(normalized);
            return Number.isFinite(numeric) ? numberFormatter.format(numeric) : normalized;
        };

        const buildBarList = (items) => {
            const max = items.length ? Math.max(...items.map(item => item.value)) : 0;
            return items.map(item => {
                const width = max ? (item.value / max) * 100 : 0;
                return `
                    <div class="bar-row">
                        <span>${item.label}</span>
                        <div class="bar-track"><span style="width: ${width}%;"></span></div>
                        <strong>${formatNumber(item.value)}</strong>
                    </div>
                `;
            }).join('');
        };

        const normalizeText = (value) => String(value || '')
            .replace(/\u00a0/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();

        const resolveColumnKey = (headers, target) => {
            const normalizedTarget = normalizeText(target);
            return headers.find(header => normalizeText(header) === normalizedTarget);
        };

        const resolveColumnKeys = (headers, targets) => {
            const keys = {};
            Object.entries(targets).forEach(([key, label]) => {
                keys[key] = resolveColumnKey(headers, label);
            });
            return keys;
        };

        const COLUMN_LABELS = {
            sector: 'ALLSVA',
            serviceType: 'المهمة حسب خطة المشرف التربوي',
            deliveryMode: 'نوع الخدمة9',
            schoolType: 'جميع مدارس الخدمة',
            gender: 'جميع النوع',
            stage: 'جميع المراحل',
            assignedSchool: 'جميع مدارس التكليف',
            additionalSchool: 'جميع المدارس الإضافية',
            supervisors: 'جميع المشرفين',
            supportFields: 'حدد مجالات الدعم الرئيسة التي ساهم المشرف بها خلال اليوم الدراسي',
            leadership: 'من وجهة نظرك ما مدى مشاركة مدير المدرسة واللجان المعنية في قيادة عمليات الدعم',
            classificationScore: 'مجمع دعم المدير والمدرسة رقم',
            complianceMadrasti: 'تفعّل المدرسة التعليم الالكتروني من خلال منصة مدرستي',
            complianceUniform: 'يلتزم الطلاب بلبس الزي السعودي الرسمي',
            complianceBehavior: 'تطبق المدرسة لائحة السلوك والمواظبة على الطلاب',
            complianceSchedule: 'تتم المحافظة على أوقات الحصص الدراسية',
            complianceAttendance: 'هل تم تثبيت الغياب بشكل منتظم خلال الاسبوع'
        };

        const SUPERVISORY_INDICATORS = [
            {
                key: 'teaching',
                shortLabel: 'التدريس',
                title: 'الإجراءات المنفذة من قبل المشرف التربوي في مجال التدريس',
                summaryColumn: 'CV',
                detailColumns: ['DS', 'DT', 'DU', 'DV', 'DW', 'DX', 'DY'],
                fixedLabels: [
                    'زيارة صفية بالتنسيق مع إدارة المدرسة واللجان المعنية بقصد التطوير أو قياس الأثر',
                    'تقديم تغذية راجعة لمعلم أو أكثر',
                    'مراجعة خطة الدرس أو الخطة الفصلية',
                    'دعم توظيف أدوات التقويم (أدائية – تحريرية – شفهية)',
                    'دعم وتحفيز تفعيل مجتمعات التعلم المهنية بين المعلمين',
                    'إعداد أو مراجعة أدوات تقييم أداء الطلاب',
                    'تقديم استشارات لدعم التعليم الالكتروني',
                    'تقديم التطوير المهني المستمر لمنسوبي المدرسة في مجال التدريس',
                    'قيم متنوعة اخرى'
                ]
            },
            {
                key: 'learning',
                shortLabel: 'نواتج التعلم',
                title: 'الإجراءات المنفذة من قبل المشرف التربوي في مجال نواتج التعلم',
                summaryColumn: 'CW',
                detailColumns: ['DZ', 'EA', 'EB', 'EC', 'ED'],
                fixedLabels: [
                    'تحليل نتائج اختبارات المدرسة أو الاختبارات الوطنية المختلفة أو دعم اللجنة المختصة بالمدرسة في ذلك',
                    'دعم ومشاركة اللجان المختصة بالمدرسة في معالجة مواطن الضعف واستثمار مواطن القوة',
                    'دعم اللجنة المختصة بالمدرسة في إعداد خطة علاجية أو إثرائية',
                    'دعم تكييف التعليم وفق الفروق الفردية',
                    'متابعة مؤشرات التحصيل عبر المنصات وغيرها',
                    'تقديم التطوير المهني المستمر لمنسوبي المدرسة في مجال نواتج التعلم',
                    'قيم متنوعة اخرى'
                ]
            },
            {
                key: 'guidance',
                shortLabel: 'التوجيه الطلابي',
                title: 'الإجراءات المنفذة من قبل المشرف التربوي في مجال التوجيه الطلابي',
                summaryColumn: 'DC',
                detailColumns: ['EE', 'EF', 'EG', 'EH', 'EI', 'EJ'],
                fixedLabels: [
                    'لقاء مع الموجه الطلابي أو لجنة التوجيه',
                    'دعم الموجه الطلابي أو اللجنة المختصة في معالجة حالات الطلاب',
                    'دعم قيم الانضباط والسلوك',
                    'دعم خطة التوجيه الطلابي السنوية',
                    'التشجيع على تبني المبادرات في الشراكة المجتمعية',
                    'دعم اللجنة المختصة في تعزيز التطور الصحي والنفسي والاجتماعي للطلبة',
                    'تقديم التطوير المهني المستمر لمنسوبي المدرسة في مجال التوجيه الطلابي',
                    'قيم متنوعة اخرى'
                ]
            },
            {
                key: 'activity',
                shortLabel: 'النشاط الطلابي',
                title: 'الإجراءات المنفذة من قبل المشرف التربوي في مجال النشاط الطلابي',
                summaryColumn: 'DD',
                detailColumns: ['EK', 'EL', 'EM', 'EN', 'EO', 'EP'],
                fixedLabels: [
                    'المشاركة في إعداد خطة النشاط',
                    'حضور أو دعم مناشط صفية أو غير صفية',
                    'مواءمة الأنشطة مع القيم والمهارات المستهدفة',
                    'دعم اللجنة المختصة بالنشاط المدرسي',
                    'إبراز إنجاز طلابي متميز',
                    'المشاركة في نشر ثقافة العمل التطوعي لمنسوبي المدرسة',
                    'تقديم التطوير المهني المستمر لمنسوبي المدرسة في مجال النشاط الطلابي',
                    'قيم متنوعة اخرى'
                ]
            }
        ];

        const parseNumber = (value) => {
            const numeric = Number(String(value || '').replace(/,/g, '').trim());
            return Number.isFinite(numeric) ? numeric : 0;
        };

        const buildSupervisoryIndicators = (rawRows, rawHeaders, selectedSector) => {
            if (!rawRows.length) {
                return [];
            }

            const sectorIndex = rawHeaders
                ? rawHeaders.findIndex(header => normalizeText(header) === normalizeText(COLUMN_LABELS.sector))
                : -1;

            const filteredRawRows = selectedSector === 'الكل' || sectorIndex === -1
                ? rawRows
                : rawRows.filter(row => normalizeText(row[sectorIndex]) === normalizeText(selectedSector));

            return SUPERVISORY_INDICATORS.map(config => {
                const summaryIndex = XLSX.utils.decode_col(config.summaryColumn);
                const summaryTotal = filteredRawRows.reduce((sum, row) => sum + parseNumber(row[summaryIndex]), 0);
                const detailItems = config.fixedLabels.map((label, index) => {
                    const columnLetter = config.detailColumns[index];
                    if (!columnLetter) {
                        return { label, value: 0 };
                    }
                    const columnIndex = XLSX.utils.decode_col(columnLetter);
                    const total = filteredRawRows.reduce((sum, row) => sum + parseNumber(row[columnIndex]), 0);
                    return { label, value: total };
                });

                return {
                    key: config.key,
                    label: config.title,
                    shortLabel: config.shortLabel,
                    value: summaryTotal,
                    items: detailItems
                };
            });
        };

        const computeSupervisorSummary = (rows, columns, selectedSector) => {
            if (!rows.length || !columns.sector || !columns.total) {
                return null;
            }

            const filteredRows = selectedSector === 'الكل'
                ? rows
                : rows.filter(row => normalizeText(row[columns.sector]) === normalizeText(selectedSector));

            if (!filteredRows.length) {
                return null;
            }

            return filteredRows.reduce((acc, row) => {
                acc.total += parseNumber(row[columns.total]);
                acc.male += parseNumber(row[columns.male]);
                acc.female += parseNumber(row[columns.female]);
                return acc;
            }, { total: 0, male: 0, female: 0 });
        };

        const computeSchoolSupportSummary = (rows, columns, selectedSector) => {
            if (!rows.length || !columns.sector || !columns.total) {
                return null;
            }

            const filteredRows = rows.filter(row => {
                const sectorValue = normalizeText(row[columns.sector]);
                if (!sectorValue || sectorValue === '0') {
                    return false;
                }
                if (selectedSector === 'الكل') {
                    return true;
                }
                return sectorValue === normalizeText(selectedSector);
            });

            if (!filteredRows.length) {
                return null;
            }

            return filteredRows.reduce((acc, row) => {
                acc.total += parseNumber(row[columns.total]);
                acc.male += parseNumber(row[columns.male]);
                acc.female += parseNumber(row[columns.female]);
                return acc;
            }, { total: 0, male: 0, female: 0 });
        };

        const computeAggregates = (rows, columns, selectedSector, baseData, supervisorRows, supervisorColumns, schoolSupportColumns, rawRows, rawHeaders) => {
            const filteredRows = selectedSector === 'الكل'
                ? rows
                : rows.filter(row => normalizeText(row[columns.sector]) === normalizeText(selectedSector));

            const countBy = (key) => {
                const counts = new Map();
                filteredRows.forEach(row => {
                    const value = normalizeText(row[key]);
                    if (!value) {
                        return;
                    }
                    counts.set(value, (counts.get(value) || 0) + 1);
                });
                return counts;
            };

            const collectUnique = (keys) => {
                const unique = new Set();
                filteredRows.forEach(row => {
                    keys.forEach(key => {
                        const value = normalizeText(row[key]);
                        if (value) {
                            unique.add(value);
                        }
                    });
                });
                return unique;
            };

            const serviceTypeCounts = countBy(columns.serviceType);
            const deliveryModeCounts = countBy(columns.deliveryMode);
            const schoolTypeCounts = countBy(columns.schoolType);
            const genderCounts = countBy(columns.gender);

            const stageCounts = new Map();
            const mapStageLabel = (rawStage) => {
                if (rawStage.includes(';')) {
                    return 'مجمع مدارس';
                }
                if (rawStage.includes('رياض')) {
                    return 'رياض الاطفال';
                }
                if (rawStage.includes('مهمة')) {
                    return 'مهمة عمل';
                }
                return rawStage;
            };

            filteredRows.forEach(row => {
                const rawStage = normalizeText(row[columns.stage]);
                if (!rawStage) {
                    return;
                }
                const stage = mapStageLabel(rawStage);
                stageCounts.set(stage, (stageCounts.get(stage) || 0) + 1);
            });

            const complianceFields = [
                { key: columns.complianceMadrasti, label: 'تفعيل منصة مدرستي' },
                { key: columns.complianceUniform, label: 'التزام الطلاب بالزي الرسمي' },
                { key: columns.complianceBehavior, label: 'تطبيق لائحة السلوك والمواظبة' },
                { key: columns.complianceSchedule, label: 'المحافظة على أوقات الحصص' },
                { key: columns.complianceAttendance, label: 'تثبيت الغياب في نظام نور' }
            ];

            const compliance = complianceFields.map(field => {
                let yes = 0;
                let no = 0;
                filteredRows.forEach(row => {
                    const value = normalizeText(row[field.key]);
                    if (value === 'نعم') {
                        yes += 1;
                    } else if (value === 'لا') {
                        no += 1;
                    }
                });
                const total = filteredRows.length;
                const unknown = Math.max(total - yes - no, 0);
                return { label: field.label, yes, no, unknown };
            });

            const leadershipCounts = countBy(columns.leadership);
            const leadershipItems = baseData.leadershipParticipation.map(item => ({
                label: item.label,
                value: leadershipCounts.get(normalizeText(item.label)) || 0
            }));

            const supportFieldTotals = new Map();
            const supportFieldKeys = [
                'التدريس',
                'نواتج التعلم',
                'التوجيه الطلابي',
                'النشاط الطلابي'
            ];
            filteredRows.forEach(row => {
                const rawValue = normalizeText(row[columns.supportFields]);
                if (!rawValue) {
                    return;
                }
                const parts = rawValue.split(';').map(part => normalizeText(part)).filter(Boolean);
                parts.forEach(part => {
                    const label = supportFieldKeys.includes(part) ? part : 'غير ذلك';
                    supportFieldTotals.set(label, (supportFieldTotals.get(label) || 0) + 1);
                });
            });

            const sectorCounts = countBy(columns.sector);
            const sectorDistribution = Array.from(sectorCounts.entries())
                .map(([label, value]) => ({ label, value }))
                .sort((a, b) => b.value - a.value);

            const sectors = Array.from(new Set(rows.map(row => normalizeText(row[columns.sector])).filter(Boolean)))
                .sort((a, b) => a.localeCompare(b, 'ar'));

            const uniqueSchools = collectUnique([columns.assignedSchool, columns.additionalSchool]);
            const uniqueSupervisors = collectUnique([columns.supervisors]);
            const supervisorSummary = computeSupervisorSummary(supervisorRows, supervisorColumns, selectedSector);
            const schoolSupportSummary = computeSchoolSupportSummary(supervisorRows, schoolSupportColumns, selectedSector);
            const supervisoryIndicators = buildSupervisoryIndicators(rawRows, rawHeaders, selectedSector);

            const summary = {
                totalReports: filteredRows.length,
                totalSchools: schoolSupportSummary ? schoolSupportSummary.total : uniqueSchools.size,
                totalSupervisors: supervisorSummary ? supervisorSummary.total : uniqueSupervisors.size,
                sectorCount: Array.from(new Set(filteredRows.map(row => normalizeText(row[columns.sector])).filter(Boolean))).length,
                maleSupervisors: supervisorSummary ? supervisorSummary.male : (genderCounts.get('بنين') || 0),
                femaleSupervisors: supervisorSummary ? supervisorSummary.female : (genderCounts.get('بنات') || 0),
                maleSupportedSchools: schoolSupportSummary ? schoolSupportSummary.male : 0,
                femaleSupportedSchools: schoolSupportSummary ? schoolSupportSummary.female : 0
            };

            return {
                ...baseData,
                filters: {
                    sectors,
                    selectedSector
                },
                summary,
                schoolClassification: baseData.schoolClassification,
                serviceTypes: baseData.serviceTypes.map(item => ({
                    label: item.label,
                    value: serviceTypeCounts.get(normalizeText(item.label)) || 0
                })),
                deliveryModes: baseData.deliveryModes.map(item => ({
                    label: item.label,
                    value: deliveryModeCounts.get(normalizeText(item.label)) || 0
                })),
                schoolTypes: baseData.schoolTypes.map(item => ({
                    label: item.label,
                    value: schoolTypeCounts.get(normalizeText(item.label)) || 0
                })),
                genderDistribution: baseData.genderDistribution.map(item => ({
                    label: item.label,
                    value: genderCounts.get(normalizeText(item.label)) || 0
                })),
                stageDistribution: baseData.stageDistribution.map(item => ({
                    label: item.label,
                    value: stageCounts.get(normalizeText(item.label)) || 0
                })),
                compliance,
                leadershipParticipation: leadershipItems,
                supportFields: baseData.supportFields.map(item => ({
                    label: item.label,
                    value: supportFieldTotals.get(normalizeText(item.label)) || 0
                })),
                sectorDistribution,
                supervisoryIndicators
            };
        };

        async function loadData() {
            try {
                const [jsonResponse, excelResponse] = await Promise.all([
                    fetch('data.json'),
                    fetch('الاسبوع الاول - تقرير مقدمي خدمة الدعم التميز.xlsx')
                ]);

                if (!jsonResponse.ok || !excelResponse.ok) {
                    throw new Error('فشل تحميل البيانات');
                }

                const baseData = await jsonResponse.json();
                const excelBuffer = await excelResponse.arrayBuffer();
                const workbook = XLSX.read(excelBuffer, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const supervisorSheet = workbook.Sheets.ALL1;
                const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                const headers = rows.length ? Object.keys(rows[0]) : [];
                const rawRows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                const rawHeaders = rawRows.length ? rawRows[0] : [];
                const rawDataRows = rawRows.length ? rawRows.slice(1) : [];
                const columns = resolveColumnKeys(headers, COLUMN_LABELS);
                const supervisorRows = supervisorSheet ? XLSX.utils.sheet_to_json(supervisorSheet, { defval: '' }) : [];
                const supervisorHeaders = supervisorRows.length ? Object.keys(supervisorRows[0]) : [];
                const supervisorColumns = resolveColumnKeys(supervisorHeaders, {
                    sector: 'قطاعات المشرفين',
                    total: 'عدد المشرفين بالقطاع',
                    male: 'عدد المشرفين بنين بالقطاع',
                    female: 'عدد المشرفين بنات بالقطاع'
                });
                const schoolSupportColumns = resolveColumnKeys(supervisorHeaders, {
                    sector: 'القطاع-عدد',
                    total: 'مجموع-بنين-بنات-عدد-شامل',
                    male: resolveColumnKey(supervisorHeaders, 'مجموع بنين-عدد')
                        || resolveColumnKey(supervisorHeaders, 'مجموع بنبن-عدد'),
                    female: 'مجموع بنات-عدد'
                });
                const selectedSector = baseData.filters?.selectedSector || 'الكل';
                const dashboardData = computeAggregates(
                    rows,
                    columns,
                    selectedSector,
                    baseData,
                    supervisorRows,
                    supervisorColumns,
                    schoolSupportColumns,
                    rawDataRows,
                    rawHeaders
                );

                renderDashboard(dashboardData, rows, columns, baseData, supervisorRows, supervisorColumns, schoolSupportColumns, rawDataRows, rawHeaders);
            } catch (error) {
                document.getElementById('app').innerHTML = `
                    <div class="card" style="text-align:center;">
                        <h2>⚠️ تعذر تحميل البيانات</h2>
                        <p style="margin-top:8px;">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderDashboard(data, rows, columns, baseData, supervisorRows, supervisorColumns, schoolSupportColumns, rawRows, rawHeaders) {
            const app = document.getElementById('app');
            const summary = data.summary;
            const supervisoryIndicators = data.supervisoryIndicators || [];

            const sectorOptions = ['الكل', ...data.filters.sectors]
                .map(option => `<option ${option === data.filters.selectedSector ? 'selected' : ''}>${option}</option>`)
                .join('');

            app.innerHTML = `
                <div class="top-bar">
                    <div class="title-group">
                        <div class="title-row">
                            <img class="report-logo" src="https://raw.githubusercontent.com/bndrjj/dash/304fef29a7c2a0ce35c72645d5da434dc81f0924/reprotlogo.png" alt="شعار وزارة التعليم" />
                            <h1><span>${data.header.title}</span></h1>
                        </div>
                        <p>${data.header.subtitle}</p>
                    </div>
                    <div class="meta">
                        <div>${normalizeDigits(data.header.year)}</div>
                        <div>${normalizeDigits(data.header.week)}</div>
                    </div>
                </div>

                <div class="classification-row">
                    ${data.schoolClassification.map(item => `
                        <div class="classification-item">
                            <span>${item.label}</span>
                            <strong>${formatNumber(item.value)}</strong>
                        </div>
                    `).join('')}
                </div>

                <div class="filters">
                    <div class="filter-card">
                        <label>القطاع</label>
                        <select id="sector-select">${sectorOptions}</select>
                    </div>
                    <div class="filter-card">
                        <label>الأسبوع</label>
                        <input type="text" value="${normalizeDigits(data.header.week)}" readonly />
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${formatNumber(summary.totalReports)}</h3>
                        <p>مجموع التقارير</p>
                    </div>
                    <div class="stat-card">
                        <h3>${formatNumber(summary.totalSchools)}</h3>
                        <p>المدارس التي يقدم لها الدعم</p>
                        <div class="stat-subtext">عدد المدارس بنين - ${formatNumber(summary.maleSupportedSchools)} ، عدد المدارس بنات - ${formatNumber(summary.femaleSupportedSchools)}</div>
                    </div>
                    <div class="stat-card">
                        <h3>${formatNumber(summary.sectorCount)}</h3>
                        <p>عدد القطاعات</p>
                    </div>
                    <div class="stat-card">
                        <h3>${formatNumber(summary.totalSupervisors)}</h3>
                        <p>مقدمو الخدمة (بنين ${formatNumber(summary.maleSupervisors)} • بنات ${formatNumber(summary.femaleSupervisors)})</p>
                    </div>
                </div>

                <section class="section">
                    <div class="section-header">
                        <div>
                            <div class="section-title title-with-icon">
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M4 18h16"></path>
                                    <path d="M7 18V10"></path>
                                    <path d="M12 18V6"></path>
                                    <path d="M17 18v-4"></path>
                                </svg>
                                <span>مؤشرات الخدمة والتقارير</span>
                            </div>
                            <div class="section-subtitle">عرض تفصيلي لأنواع الخدمة والتوزيع بحسب نوع المدرسة</div>
                        </div>
                    </div>
                    <div class="cards-grid">
                        <div class="card">
                            <h4>
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M5 6h14"></path>
                                    <path d="M5 12h14"></path>
                                    <path d="M5 18h14"></path>
                                </svg>
                                <span>نوع الخدمة المقدمة</span>
                            </h4>
                            <div class="metric-list">
                                ${data.serviceTypes.map(item => `
                                    <div class="metric-row">
                                        <span>${item.label}</span>
                                        <strong>${formatNumber(item.value)}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="card">
                            <h4>
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M4 10l8-6 8 6"></path>
                                    <path d="M6 10v8h12v-8"></path>
                                    <path d="M10 18v-4h4v4"></path>
                                </svg>
                                <span>نوع المدرسة حسب التقارير</span>
                            </h4>
                            <div class="metric-list">
                                ${data.genderDistribution.map(item => `
                                    <div class="metric-row">
                                        <span>${item.label}</span>
                                        <strong>${formatNumber(item.value)}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="card">
                            <h4>
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M4 7h16"></path>
                                    <path d="M4 12h10"></path>
                                    <path d="M4 17h7"></path>
                                    <path d="M17 12l3 3"></path>
                                    <path d="M20 12l-3 3"></path>
                                </svg>
                                <span>أسلوب تقديم الخدمة</span>
                            </h4>
                            <div class="metric-list">
                                ${data.deliveryModes.map(item => `
                                    <div class="metric-row">
                                        <span>${item.label}</span>
                                        <strong>${formatNumber(item.value)}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="card">
                            <h4>
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <circle cx="6" cy="12" r="2.5"></circle>
                                    <circle cx="12" cy="7" r="2.5"></circle>
                                    <circle cx="18" cy="12" r="2.5"></circle>
                                    <path d="M6 14.5v3.5"></path>
                                    <path d="M12 9.5V18"></path>
                                    <path d="M18 14.5v3.5"></path>
                                </svg>
                                <span>أنواع المدارس المستفيدة</span>
                            </h4>
                            <div class="metric-list">
                                ${data.schoolTypes.map(item => `
                                    <div class="metric-row">
                                        <span>${item.label}</span>
                                        <strong>${formatNumber(item.value)}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </section>

                <section class="section">
                    <div class="section-header">
                        <div>
                            <div class="section-title title-with-icon">
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M6 12l4 4 8-8"></path>
                                    <path d="M4 7h16"></path>
                                </svg>
                                <span>الالتزام بتطبيقات المدرسة</span>
                            </div>
                            <div class="section-subtitle">نسب تفعيل مدرستي والسلوك والمواظبة والانضباط</div>
                        </div>
                    </div>
                    <div class="compliance-grid">
                        ${data.compliance.map(item => {
                            const total = item.yes + item.no + item.unknown;
                            const yesRate = total ? (item.yes / total) * 100 : 0;
                            return `
                                <div class="compliance-card">
                                    <h4>
                                        <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                            <path d="M5 13l4 4 10-10"></path>
                                        </svg>
                                        <span>${item.label}</span>
                                    </h4>
                                    <div class="compliance-values">
                                        <span class="badge yes">نعم ${formatNumber(item.yes)}</span>
                                        <span class="badge no">لا ${formatNumber(item.no)}</span>
                                        <span class="badge unknown">غير محدد ${formatNumber(item.unknown)}</span>
                                    </div>
                                    <div class="progress"><span style="width: ${yesRate}%;"></span></div>
                                    <div class="compliance-gauge">
                                        <div class="gauge-ring" style="--value: ${yesRate.toFixed(1)};">
                                            <span>${yesRate.toFixed(1)}%</span>
                                        </div>
                                        <div class="gauge-caption">نسبة الالتزام</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </section>

                <section class="section">
                    <div class="section-header">
                        <div>
                            <div class="section-title title-with-icon">
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M4 16h4V8H4z"></path>
                                    <path d="M10 16h4V4h-4z"></path>
                                    <path d="M16 16h4v-6h-4z"></path>
                                </svg>
                                <span>التوزيع حسب المرحلة والقطاعات</span>
                            </div>
                            <div class="section-subtitle">توزيع المدارس وتقارير المشرفين حسب المرحلة والقطاع</div>
                        </div>
                    </div>
                    <div class="cards-grid">
                        <div class="card">
                            <h4>
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M5 20V6l7-3 7 3v14"></path>
                                    <path d="M9 20v-6h6v6"></path>
                                </svg>
                                <span>المرحلة الدراسية</span>
                            </h4>
                            <div class="bar-list">
                                ${buildBarList(data.stageDistribution)}
                            </div>
                        </div>
                        <div class="card">
                            <h4>
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 3v18"></path>
                                    <path d="M3 12h18"></path>
                                </svg>
                                <span>التوزيع على القطاعات</span>
                            </h4>
                            <div class="bar-list">
                                ${buildBarList(data.sectorDistribution)}
                            </div>
                        </div>
                    </div>
                </section>

                <section class="section">
                    <div class="section-header">
                        <div>
                            <div class="section-title title-with-icon">
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M7 20v-6h10v6"></path>
                                    <path d="M5 9l7-5 7 5"></path>
                                    <path d="M12 9v5"></path>
                                </svg>
                                <span>مشاركة قيادة المدرسة</span>
                            </div>
                            <div class="section-subtitle">مدى مشاركة القيادة في تنفيذ عمليات الدعم</div>
                        </div>
                    </div>
                    <div class="cards-grid">
                        <div class="card">
                            <div class="bar-list">
                                ${buildBarList(data.leadershipParticipation)}
                            </div>
                        </div>
                        <div class="card">
                            <h4>
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M4 6h16"></path>
                                    <path d="M4 12h16"></path>
                                    <path d="M4 18h10"></path>
                                </svg>
                                <span>مجالات الدعم المنفذة</span>
                            </h4>
                            <div class="bar-list">
                                ${buildBarList(data.supportFields)}
                            </div>
                        </div>
                    </div>
                </section>

                <section class="section">
                    <div class="section-header">
                        <div>
                            <div class="section-title title-with-icon">
                                <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M4 19h16"></path>
                                    <path d="M6 17V9"></path>
                                    <path d="M12 17V5"></path>
                                    <path d="M18 17v-6"></path>
                                </svg>
                                <span>المؤشرات الخاصة بالمجالات الإشرافية لتقديم الدعم</span>
                            </div>
                            <div class="section-subtitle">مؤشر شامل لأربع مجالات إشرافية مع تفاصيل الإجراءات لكل مجال</div>
                        </div>
                    </div>
                    <div class="supervisory-grid">
                        ${supervisoryIndicators.map(indicator => `
                            <div class="card supervisory-domain">
                                <h4>
                                    <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M4 10h16"></path>
                                        <path d="M4 14h16"></path>
                                        <path d="M4 18h10"></path>
                                    </svg>
                                    <span>${indicator.title}</span>
                                </h4>
                                <div class="bar-list">
                                    ${buildBarList(indicator.items)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>

                <div class="footer">
                    تم تحديث البيانات آليًا من ملف التقارير الأسبوعي • جميع الأرقام مستخرجة من قاعدة البيانات المصدرية
                </div>
            `;

            const sectorSelect = document.getElementById('sector-select');
            if (sectorSelect) {
                sectorSelect.addEventListener('change', (event) => {
                    const nextSector = event.target.value;
                    const updatedData = computeAggregates(
                        rows,
                        columns,
                        nextSector,
                        baseData,
                        supervisorRows,
                        supervisorColumns,
                        schoolSupportColumns,
                        rawRows,
                        rawHeaders
                    );
                    renderDashboard(updatedData, rows, columns, baseData, supervisorRows, supervisorColumns, schoolSupportColumns, rawRows, rawHeaders);
                });
            };

            if (defaultIndicatorKey) {
                setIndicatorDetail(defaultIndicatorKey);
            }

            indicatorButtons.forEach(button => {
                button.addEventListener('click', () => {
                    setIndicatorDetail(button.dataset.indicator);
                });
            });
        }

        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
